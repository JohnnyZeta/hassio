
  - alias: Allarme
    trigger:
      - platform: state
        entity_id: binary_sensor.door_window_sensor_158d0001bf80f4, binary_sensor.door_window_sensor_158d0001ab6dbe, binary_sensor.door_window_sensor_158d0001e48bd5, binary_sensor.door_window_sensor_158d0001ab2e3e, binary_sensor.door_window_sensor_158d0001b97e2e, binary_sensor.door_window_sensor_158d0001bf80d3, binary_sensor.door_window_sensor_158d0001de8c1e, binary_sensor.door_window_sensor_158d0001de6ed0, binary_sensor.door_window_sensor_158d0001daeef7
        from: 'off'
        to: 'on'
      - platform: state
        entity_id: binary_sensor.motion_sensor_158d0001a8e47c, binary_sensor.motion_sensor_158d0001a8fb6a, binary_sensor.motion_sensor_158d0001a8fa9d, binary_sensor.motion_sensor_158d0001dc2ed5
        from: 'off'
        to: 'on'
    condition:
      condition: or
      conditions:
        - condition: state
          entity_id: group.famiglia
          state: not_home
          for:
            minutes: 5
        - condition: and
          conditions:
            - condition: state
              entity_id: device_tracker.alessandra_iphone
              state: not_home
            - condition: state
              entity_id: input_boolean.corsa
              state: "on"
    action:
      - service: shell_command.riga_allarme
      - service: notify.telefoni
        data_template:
          title: "ALLARME!"
          message: >
            {{ trigger.from_state.attributes.friendly_name }} Ã¨ appena passata da {{ trigger.from_state.state }} a {{ trigger.to_state.state }}. In allegato lo stream della camera:
          data:
            attachment:
              content-type: jpeg
            push:
              category: camera
            entity_id: camera.cucina
      - service: camera.snapshot
        data:
          entity_id: camera.cucina
          filename: '/config/www/cucina_istant_{{ now().strftime("%Y_%m_%d-%H%M") }}.jpg'
      - delay: "00:00:01"
      - service: camera.snapshot
        data:
          entity_id: camera.cucina
          filename: '/config/www/cucina_1s_{{ now().strftime("%Y_%m_%d-%H%M") }}.jpg'
      - delay: "00:00:04"
      - service: camera.snapshot
        data:
          entity_id: camera.cucina
          filename: '/config/www/cucina_5s_{{ now().strftime("%Y_%m_%d-%H%M") }}.jpg'
      - service: notify.telegram
        data_template:
          message: "Ecco gli screenshot fatti subito, a 1s e a 5s:"
          data:
            photo:
              - file: /config/www/cucina_istant_{{ now().strftime("%Y_%m_%d-%H%M") }}.jpg
                caption: Istantaneo
              - file: /config/www/cucina_1s_{{ now().strftime("%Y_%m_%d-%H%M") }}.jpg
                caption: Dopo 1 secondo
              - file: /config/www/cucina_5s_{{ now().strftime("%Y_%m_%d-%H%M") }}.jpg
                caption: Dopo 5 secondi

###############################################################################
