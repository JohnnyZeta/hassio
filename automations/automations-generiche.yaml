
  - alias: Notifica aggiornamento
    trigger:
    - platform: state
      entity_id: updater.updater
    action:
      service: notify.telegram
      data_template:
        message: "È disponibile Home Assistant {{ states.updater.updater.state }}."

###############################################################################

  - alias: Backup Automatico
    trigger:
      platform: time
      at: '3:00:00'
    condition:
      - condition: time
        weekday:
          - mon
          - thu
    action:
      - service: hassio.snapshot_full
        data_template:
          name: Automated Backup {{ now().strftime('%Y-%m-%d') }}
      - service: shell_command.backup_script
      - delay: 00:00:30
      - service: shell_command.backup_reload

###############################################################################

#   - alias: Avviso Semola ON
#     trigger:
#       platform: state
#       entity_id: vacuum.semola
#       from: 'off'
#       to: 'on'
#     condition:
# #      - condition: template
# #        value_template: '{{ not is_state("switch.semola_schedule", "off") }}'
#       - condition: time
#         weekday:
#           - mon
#           - tue
#           - wed
#           - thu
#           - fri
#     action:
#       service: notify.telefoni
#       data:
#         title: "Semola è partito!"


  - alias: Avviso Semola OFF
    trigger:
      platform: state
      entity_id: vacuum.semola
      from: 'on'
      to: 'off'
    condition:
#      - condition: template
#        value_template: '{{ not is_state("switch.semola_schedule", "off") }}'
      - condition: time
        weekday:
          - mon
          - tue
          - wed
          - thu
          - fri
    action:
      - delay: 00:00:30
      # il delay serve per finire il caricamento della mappa pulizia dal server
      - service: notify.telefoni
        data_template:
          title: "Semola ha finito"
          message: >
            Ha appena pulito {{ states.vacuum.semola.attributes.clean_area }} mq e adesso ha il {{ states.vacuum.semola.attributes.battery_level }}% di batteria. In allegato la mappa della pulizia.
          data:
            attachment:
              content-type: jpeg
            push:
              category: camera
            entity_id: camera.semola_cleaning_map

###############################################################################

  - alias: Vento Forte
    trigger:
      platform: numeric_state
      entity_id: sensor.dark_sky_wind_speed_1
      above: 3
      for:
        hours: 2
    condition:
      condition: time
      after: '09:00:00'
      before: '18:00:00'
    action:
      service: notify.telefoni
      data:
        message: "Vento forte previsto domani!"

###############################################################################

  # - alias: Programmazione Nuvola
  #   trigger:
  #     platform: time
  #     at: '22:45:00'
  #   condition:
  #     condition: time
  #     weekday:
  #       - mon
  #       - tue
  #       - wed
  #       - thu
  #       - sun
  #   action:
  #     - service: switch.turn_on
  #       entity_id: switch.nuvola
  #     - delay: 01:00:00
  #     - service: switch.turn_off
  #       entity_id: switch.nuvola

###############################################################################

  - alias: Timer Spegnimento Nuvola
    trigger:
      platform: state
      entity_id: switch.nuvola
      from: 'off'
      to: 'on'
    action:
      - delay: '00:15:00'
      - service: switch.turn_off
        data:
          entity_id: switch.nuvola

###############################################################################

  - alias: Spazio Libero
    trigger:
      platform: numeric_state
      entity_id: sensor.disk_use_percent_home
      above: 90
      below: 95
    action:
      - service: notify.ios_iphone_di_alby
        data:
          message: "Spazio libero sulla SD in esaurimento!"
      - service: automation.turn_off
        data:
          entity_id: automation.backup_automatico
      - service: notify.ios_iphone_di_alby
        data:
          message: "Backup Automatico disattivato"

###############################################################################

  - alias: "Aggiorna Ultimo Movimento"
    trigger:
      - platform: state
        entity_id: binary_sensor.motion_sensor_158d0001a8e47c, binary_sensor.motion_sensor_158d0001a8fb6a, binary_sensor.motion_sensor_158d0001a8fa9d, binary_sensor.motion_sensor_158d0001dc2ed5
        to: 'on'
    action:
      - service: variable.set_variable
        data:
          variable: ultimo_movimento
          attributes_template: >
             {
                "history_1": "{{ variable.state }}",
                "history_2": "{{ variable.attributes.history_1 }}",
                "history_3": "{{ variable.attributes.history_2 }}"
              }
        data_template:
          value: "{{ trigger.to_state.attributes.friendly_name }}"

###############################################################################

  - alias: Set Spotify Volume
    trigger:
      platform: state
      entity_id: input_number.spotify_volume
    action:
      service: media_player.volume_set
      data_template:
        entity_id: media_player.spotify
        volume_level: '{{ states.input_number.spotify_volume.state }}'

  - alias: Set Yamaha Volume
    trigger:
      platform: state
      entity_id: input_number.yamaha_volume
    action:
      service: media_player.volume_set
      data_template:
        entity_id: media_player.yamaha_receiver
        volume_level: '{{ states.input_number.yamaha_volume.state }}'

###############################################################################
